generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Commission {
  id            String    @id
  userId        String
  referralId    String
  amount        Float
  currency      String    @default("usd")
  stripeEventId String    @unique
  type          String
  status        String    @default("pending")
  createdAt     DateTime  @default(now())
  paidAt        DateTime?
  payoutId      String?
  Payout        Payout?   @relation(fields: [payoutId], references: [id])
  Referral      Referral  @relation(fields: [referralId], references: [id])
  User          User      @relation(fields: [userId], references: [id])

  @@index([status])
  @@index([userId])
}

model Payout {
  id             String       @id
  userId         String
  amount         Float
  currency       String       @default("usd")
  status         String       @default("pending")
  method         String?
  stripePayoutId String?      @unique
  createdAt      DateTime     @default(now())
  completedAt    DateTime?
  Commission     Commission[]
  User           User         @relation(fields: [userId], references: [id])

  @@index([status])
  @@index([userId])
}

model Referral {
  id             String       @id
  userId         String
  referredUserId String
  referredEmail  String
  isPaying       Boolean      @default(false)
  subscriptionId String?      @unique
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  Commission     Commission[]
  User           User         @relation(fields: [userId], references: [id])

  @@index([referredUserId])
  @@index([userId])
}

model User {
  id            String       @id
  clerkId       String       @unique
  email         String       @unique
  affiliateCode String       @unique
  referredBy    String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime
  Commission    Commission[]
  Payout        Payout[]
  Referral      Referral[]
  User          User?        @relation("UserToUser", fields: [referredBy], references: [affiliateCode])
  other_User    User[]       @relation("UserToUser")

  @@index([affiliateCode])
  @@index([referredBy])
}
