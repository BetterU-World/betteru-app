"use client";

import { useState, useEffect } from "react";
import Header from "@/components/Header";
import MonthView from "@/components/calendar/MonthView";
import WeekView from "@/components/calendar/WeekView";
import DayView from "@/components/calendar/DayView";
import DateDetailsPanel from "@/components/calendar/DateDetailsPanel";
import EventDialog from "@/components/calendar/EventDialog";
import { Button } from "@/components/ui/button";
import { CalendarEvent, DiaryEntry, ViewType, getMonthName, formatDateForAPI, getEventsForDate, getDiaryEntriesForDate } from "@/lib/calendar-utils";
import { ChevronLeft, ChevronRight } from "lucide-react";

interface Calendar {
  id: string;
  name: string;
  color: string;
  _count: {
    events: number;
  };
}

interface CalendarEvent {
  id: string;
  calendarId: string;
  title: string;
  description: string;
  start: string;
  end: string;
  allDay: boolean;
  calendar: {
    id: string;
    name: string;
    color: string;
  };
}

export default function CalendarPage() {
  const [calendars, setCalendars] = useState<Calendar[]>([]);
  const [events, setEvents] = useState<CalendarEvent[]>([]);
  const [selectedCalendarIds, setSelectedCalendarIds] = useState<Set<string>>(
    new Set()
  );
  const [currentDate, setCurrentDate] = useState(new Date());
  const [selectedDate, setSelectedDate] = useState<Date | null>(null);

  // Edit calendar modal state
  const [editingCalendar, setEditingCalendar] = useState<Calendar | null>(null);

  // New calendar form
  const [newCalendarName, setNewCalendarName] = useState("");
  const [newCalendarColor, setNewCalendarColor] = useState("#4f46e5");

  // New event form
  const [showEventForm, setShowEventForm] = useState(false);
  const [eventCalendarId, setEventCalendarId] = useState("");
  const [eventTitle, setEventTitle] = useState("");
  const [eventDescription, setEventDescription] = useState("");
  const [eventDate, setEventDate] = useState("");
  const [eventStartTime, setEventStartTime] = useState("09:00");
  const [eventEndTime, setEventEndTime] = useState("10:00");
  const [eventAllDay, setEventAllDay] = useState(false);

  // Fetch calendars
  const fetchCalendars = async () => {
    try {
      const res = await fetch("/api/calendars");
      if (res.ok) {
        const data = await res.json();
        setCalendars(data);
        // Select all calendars by default
        setSelectedCalendarIds(new Set(data.map((c: Calendar) => c.id)));
      }
    } catch (error) {
      console.error("Failed to fetch calendars:", error);
    }
  };

  // Fetch events for current month and selected calendars
  const fetchEvents = async () => {
    try {
      const month = currentDate.getMonth() + 1;
      const year = currentDate.getFullYear();
      const calendarIdsParam = Array.from(selectedCalendarIds).join(",");

      const params = new URLSearchParams({
        month: String(month),
        year: String(year),
      });

      if (calendarIdsParam) {
        params.append("calendarIds", calendarIdsParam);
      }

      const res = await fetch(`/api/calendar-events?${params}`);
      if (res.ok) {
        const data = await res.json();
        setEvents(data);
      }
    } catch (error) {
      console.error("Failed to fetch events:", error);
    }
  };

  useEffect(() => {
    const initializeCalendars = async () => {
      await fetchCalendars();
      
      // Check for calendar filter in URL
      const params = new URLSearchParams(window.location.search);
      const calendarFilter = params.get("calendar");
      
      if (calendarFilter) {
        // Wait a tick for calendars state to update
        setTimeout(() => {
          const systemCalendarNames: { [key: string]: string } = {
            diary: "Diary",
            finances: "Finances",
            goals: "Goals",
          };
          
          const targetName = systemCalendarNames[calendarFilter];
          if (targetName) {
            const targetCalendar = calendars.find(c => c.name === targetName);
            if (targetCalendar) {
              setSelectedCalendarIds(new Set([targetCalendar.id]));
            }
          }
        }, 100);
      }
    };
    
    initializeCalendars();
  }, []);

  useEffect(() => {
    if (calendars.length > 0) {
      fetchEvents();
    }
  }, [currentDate, selectedCalendarIds, calendars.length]);

  const handleCreateCalendar = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!newCalendarName.trim()) return;

    try {
      const res = await fetch("/api/calendars", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: newCalendarName,
          color: newCalendarColor,
        }),
      });

      if (res.ok) {
        setNewCalendarName("");
        setNewCalendarColor("#4f46e5");
        fetchCalendars();
      }
    } catch (error) {
      console.error("Failed to create calendar:", error);
    }
  };

  const handleCreateEvent = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!eventCalendarId || !eventTitle.trim() || !eventDate) return;

    try {
      let start: Date;
      let end: Date;

      if (eventAllDay) {
        start = new Date(eventDate + "T00:00:00");
        end = new Date(eventDate + "T23:59:59");
      } else {
        start = new Date(eventDate + "T" + eventStartTime);
        end = new Date(eventDate + "T" + eventEndTime);
      }

      const res = await fetch("/api/calendar-events", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          calendarId: eventCalendarId,
          title: eventTitle,
          description: eventDescription,
          start: start.toISOString(),
          end: end.toISOString(),
          allDay: eventAllDay,
        }),
      });

      if (res.ok) {
        setEventTitle("");
        setEventDescription("");
        setEventDate("");
        setEventStartTime("09:00");
        setEventEndTime("10:00");
        setEventAllDay(false);
        setShowEventForm(false);
        fetchEvents();
      }
    } catch (error) {
      console.error("Failed to create event:", error);
    }
  };

  const toggleCalendar = (calendarId: string) => {
    const newSet = new Set(selectedCalendarIds);
    if (newSet.has(calendarId)) {
      newSet.delete(calendarId);
    } else {
      newSet.add(calendarId);
    }
    setSelectedCalendarIds(newSet);
  };

  const handleUpdateCalendar = async (id: string, name: string, color: string) => {
    const res = await fetch(`/api/calendars/${id}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, color }),
    });

    if (!res.ok) {
      throw new Error("Failed to update calendar");
    }

    const updatedCalendar = await res.json();
    setCalendars((prev) =>
      prev.map((cal) => (cal.id === id ? updatedCalendar : cal))
    );
    fetchEvents(); // Refresh events in case calendar color changed
  };

  const handleDeleteCalendar = async (id: string) => {
    const res = await fetch(`/api/calendars/${id}`, {
      method: "DELETE",
    });

    if (!res.ok) {
      throw new Error("Failed to delete calendar");
    }

    setCalendars((prev) => prev.filter((cal) => cal.id !== id));
    
    // Remove from selected calendars if it was selected
    const newSet = new Set(selectedCalendarIds);
    newSet.delete(id);
    setSelectedCalendarIds(newSet);

    // Refresh events
    fetchEvents();
  };

  const handlePrevMonth = () => {
    setCurrentDate(
      new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1)
    );
  };

  const handleNextMonth = () => {
    setCurrentDate(
      new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1)
    );
  };

  const handleDateClick = (date: Date) => {
    setSelectedDate(date);
    setEventDate(date.toISOString().split("T")[0]);
  };

  // Group events by date for the calendar
  const eventsByDate: Record<string, CalendarEvent[]> = {};
  events.forEach((event) => {
    const dateKey = event.start.split("T")[0];
    if (!eventsByDate[dateKey]) {
      eventsByDate[dateKey] = [];
    }
    eventsByDate[dateKey].push(event);
  });

  // Get events for selected date
  const selectedDateEvents = selectedDate
    ? eventsByDate[selectedDate.toISOString().split("T")[0]] || []
    : [];

  return (
    <div className="p-4 md:p-6 max-w-7xl mx-auto">
      <div className="space-y-6">
        <div>
          <h1 className="text-2xl font-semibold tracking-tight text-slate-900">Calendar</h1>
          <p className="text-sm text-slate-500 mt-1">Organize your events and schedules across multiple calendars.</p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
          {/* Sidebar: Calendar list */}
          <div className="md:col-span-1 space-y-4">
            {/* Create new calendar */}
            <div className="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200">
              <h2 className="text-lg font-semibold mb-3">Create Calendar</h2>
              <form onSubmit={handleCreateCalendar} className="space-y-3">
                <input
                  type="text"
                  placeholder="Calendar name"
                  value={newCalendarName}
                  onChange={(e) => setNewCalendarName(e.target.value)}
                  className="w-full border border-gray-300 rounded px-3 py-2"
                />
                <div className="flex items-center space-x-2">
                  <label className="text-sm text-gray-600">Color:</label>
                  <input
                    type="color"
                    value={newCalendarColor}
                    onChange={(e) => setNewCalendarColor(e.target.value)}
                    className="w-12 h-8 border border-gray-300 rounded cursor-pointer"
                  />
                </div>
                <button
                  type="submit"
                  className="w-full bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition"
                >
                  Add Calendar
                </button>
              </form>
            </div>

            {/* My Calendars */}
            <div className="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200">
              <h2 className="text-lg font-semibold mb-3">My Calendars</h2>
              {calendars.length === 0 ? (
                <p className="text-gray-500 text-sm">No calendars yet.</p>
              ) : (
                <>
                  {/* System Calendars */}
                  {calendars.filter(c => ["Diary", "Finances", "Goals"].includes(c.name)).length > 0 && (
                    <div className="mb-4">
                      <h3 className="text-xs font-medium text-gray-500 uppercase mb-2">
                        Built-in
                      </h3>
                      <div className="space-y-2">
                        {calendars
                          .filter(c => ["Diary", "Finances", "Goals"].includes(c.name))
                          .map((calendar) => (
                            <div
                              key={calendar.id}
                              className="flex items-center space-x-2 hover:bg-gray-50 p-2 rounded"
                            >
                              <input
                                type="checkbox"
                                checked={selectedCalendarIds.has(calendar.id)}
                                onChange={() => toggleCalendar(calendar.id)}
                                className="w-4 h-4 cursor-pointer"
                              />
                              <div
                                className="w-4 h-4 rounded"
                                style={{ backgroundColor: calendar.color }}
                              ></div>
                              <span className="text-sm flex-1">
                                {calendar.name} ({calendar._count.events})
                              </span>
                            </div>
                          ))}
                      </div>
                    </div>
                  )}

                  {/* Custom Calendars */}
                  {calendars.filter(c => !["Diary", "Finances", "Goals"].includes(c.name)).length > 0 && (
                    <div>
                      <h3 className="text-xs font-medium text-gray-500 uppercase mb-2">
                        Custom
                      </h3>
                      <div className="space-y-2">
                        {calendars
                          .filter(c => !["Diary", "Finances", "Goals"].includes(c.name))
                          .map((calendar) => (
                            <div
                              key={calendar.id}
                              className="flex items-center space-x-2 hover:bg-gray-50 p-2 rounded group"
                            >
                              <input
                                type="checkbox"
                                checked={selectedCalendarIds.has(calendar.id)}
                                onChange={() => toggleCalendar(calendar.id)}
                                className="w-4 h-4 cursor-pointer"
                              />
                              <div
                                className="w-4 h-4 rounded"
                                style={{ backgroundColor: calendar.color }}
                              ></div>
                              <span className="text-sm flex-1">
                                {calendar.name} ({calendar._count.events})
                              </span>
                              <button
                                onClick={() => setEditingCalendar(calendar)}
                                className="opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-gray-200 rounded"
                                title="Edit calendar"
                              >
                                <svg
                                  className="w-4 h-4 text-gray-600"
                                  fill="none"
                                  stroke="currentColor"
                                  viewBox="0 0 24 24"
                                >
                                  <path
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                    strokeWidth={2}
                                    d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
                                  />
                                </svg>
                              </button>
                            </div>
                          ))}
                      </div>
                    </div>
                  )}
                </>
              )}
            </div>
          </div>

          {/* Main area: Calendar and events */}
          <div className="md:col-span-3 space-y-6">
            {/* Month calendar */}
            <MonthCalendar
              currentDate={currentDate}
              eventsByDate={eventsByDate}
              onPrevMonth={handlePrevMonth}
              onNextMonth={handleNextMonth}
              onDateClick={handleDateClick}
            />

            {/* Selected date info */}
            {selectedDate && (
              <div className="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-xl font-semibold">
                    Events on {selectedDate.toLocaleDateString()}
                  </h2>
                  <button
                    onClick={() => setShowEventForm(!showEventForm)}
                    className="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition"
                  >
                    {showEventForm ? "Cancel" : "Add Event"}
                  </button>
                </div>

                {/* Event form */}
                {showEventForm && (
                  <form
                    onSubmit={handleCreateEvent}
                    className="mb-4 p-4 bg-gray-50 rounded space-y-3"
                  >
                    <select
                      value={eventCalendarId}
                      onChange={(e) => setEventCalendarId(e.target.value)}
                      className="w-full border border-gray-300 rounded px-3 py-2"
                      required
                    >
                      <option value="">Select Calendar</option>
                      {calendars.map((calendar) => (
                        <option key={calendar.id} value={calendar.id}>
                          {calendar.name}
                        </option>
                      ))}
                    </select>
                    <input
                      type="text"
                      placeholder="Event title"
                      value={eventTitle}
                      onChange={(e) => setEventTitle(e.target.value)}
                      className="w-full border border-gray-300 rounded px-3 py-2"
                      required
                    />
                    <textarea
                      placeholder="Description (optional)"
                      value={eventDescription}
                      onChange={(e) => setEventDescription(e.target.value)}
                      className="w-full border border-gray-300 rounded px-3 py-2"
                      rows={2}
                    />
                    <input
                      type="date"
                      value={eventDate}
                      onChange={(e) => setEventDate(e.target.value)}
                      className="w-full border border-gray-300 rounded px-3 py-2"
                      required
                    />
                    <label className="flex items-center space-x-2">
                      <input
                        type="checkbox"
                        checked={eventAllDay}
                        onChange={(e) => setEventAllDay(e.target.checked)}
                        className="w-4 h-4"
                      />
                      <span className="text-sm">All-day event</span>
                    </label>
                    {!eventAllDay && (
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="text-sm text-gray-600">
                            Start time
                          </label>
                          <input
                            type="time"
                            value={eventStartTime}
                            onChange={(e) => setEventStartTime(e.target.value)}
                            className="w-full border border-gray-300 rounded px-3 py-2"
                          />
                        </div>
                        <div>
                          <label className="text-sm text-gray-600">
                            End time
                          </label>
                          <input
                            type="time"
                            value={eventEndTime}
                            onChange={(e) => setEventEndTime(e.target.value)}
                            className="w-full border border-gray-300 rounded px-3 py-2"
                          />
                        </div>
                      </div>
                    )}
                    <button
                      type="submit"
                      className="w-full bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition"
                    >
                      Create Event
                    </button>
                  </form>
                )}

                {/* Event list */}
                {selectedDateEvents.length === 0 ? (
                  <p className="text-gray-500 text-sm">
                    No events on this date.
                  </p>
                ) : (
                  <div className="space-y-3">
                    {selectedDateEvents.map((event) => (
                      <div
                        key={event.id}
                        className="p-3 border rounded"
                        style={{ borderLeftColor: event.calendar.color, borderLeftWidth: '4px' }}
                      >
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <h3 className="font-semibold">{event.title}</h3>
                            <p className="text-sm text-gray-600">
                              {event.calendar.name}
                            </p>
                            {event.description && (
                              <p className="text-sm text-gray-700 mt-1">
                                {event.description}
                              </p>
                            )}
                            <p className="text-sm text-gray-500 mt-1">
                              {event.allDay
                                ? "All day"
                                : `${new Date(
                                    event.start
                                  ).toLocaleTimeString()} - ${new Date(
                                    event.end
                                  ).toLocaleTimeString()}`}
                            </p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}
          </div>
        </div>

        {/* Edit Calendar Modal */}
        {editingCalendar && (
          <EditCalendarModal
            calendar={editingCalendar}
            onClose={() => setEditingCalendar(null)}
            onSave={handleUpdateCalendar}
            onDelete={handleDeleteCalendar}
          />
        )}
      </div>
    </div>
  );
}
